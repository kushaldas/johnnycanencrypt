name: ci-pr
on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'sm2/**'
      - 'Cargo.lock'
      - 'Cargo.toml'
      - 'pyproject.toml'
  workflow_dispatch:
env:
  FORCE_COLOR: "1"
  UV_LINK_MODE: "copy"
jobs:

  manylinux_x86_64:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
    steps:
    - uses: actions/checkout@v5

    - name: Pull the manylinux image
      run: docker pull quay.io/pypa/manylinux_2_28_x86_64

    - name: Build the wheel inside manylinux container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/io \
          quay.io/pypa/manylinux_2_28_x86_64 \
          /io/build-wheels.sh

    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv venv
        source .venv/bin/activate
        uv pip install pytest vcrpy
        uv pip install ./dist/johnnycanencrypt-*.whl

    - name: Install libpcsclite1
      run: sudo apt install libpcsclite1 -y

    - name: Rust tests
      run: |
        source .venv/bin/activate
        cd tests
        python -m pytest -vvv

    - name: Install smartcard dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pcscd \
          libpcsclite-dev \
          pcsc-tools \
          gnupg \
          gnupg-agent \
          scdaemon

    - name: Install yubico-piv-tool from kushal's build
      run: |
        wget https://kushaldas.in/yubico.tar.gz
        echo "222b9deb97dcd2ad03f216ac42caea91bd875d6f3e838d3f4a9ab0d01c433c4c yubico.tar.gz" | sha256sum -c -
        tar xvf yubico.tar.gz
        sudo apt install ./yubico/*.deb

    - name: Install just
      uses: extractions/setup-just@v2

    - name: Make just available for root
      run: |
        sudo ln -sf $(which just) /usr/local/bin/just

    - name: Install jcecard and start virtual smartcard
      run: |
        # Clone and build jcecard from source
        git clone https://github.com/kushaldas/jcecard.git /tmp/jcecard
        source ${{ github.workspace }}/.venv/bin/activate
        uv pip install pyscard
        uv pip install jcecard
        cd /tmp/jcecard
        just install-prbuilt-ifd
        mkdir -p ~/.gnupg
        chmod 700 ~/.gnupg
        echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
        echo "disable-ccid" >> ~/.gnupg/scdaemon.conf
        gpgconf --kill all || true
        echo "Starting jcecard TCP server"
        nohup python -m jcecard.tcp_server --debug > /tmp/tcp_server.log 2>&1 &
        sleep 2
        # Stop any existing pcscd first (ubuntu-latest has it running by default)
        sudo systemctl stop pcscd.socket pcscd.service 2>/dev/null || true
        sudo pkill -9 pcscd 2>/dev/null || true
        sleep 1
        # Start pcscd in debug mode with polkit disabled (required for CI)
        # Ubuntu's pcscd 2.0+ uses polkit for authorization which blocks non-root users
        sudo /usr/sbin/pcscd --foreground --debug --apdu --disable-polkit > /tmp/pcscd_debug.log 2>&1 &
        sleep 3
        # Verify services are running
        pgrep -f tcp_server && echo "TCP server is running"
        pgrep pcscd && echo "pcscd is running"
        # Verify card is accessible via PC/SC
        python -c "from smartcard.System import readers; r = readers(); print(f'Readers: {r}'); assert len(r) > 0, 'No readers found'"
    

    - name: Run smartcard tests
      run: |
        source .venv/bin/activate
        python sm2/smartcards.py
        python sm2/smartcards_for_primary.py

    - name: Upload smartcard logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: smartcard-debug-logs
        path: /tmp/pcscd_debug.log
        retention-days: 1

    - name: Store wheels
      uses: actions/upload-artifact@v4
      with:
        name: johnnycanencrypt_manylinux_x86_64
        path: dist/
        overwrite: true
        retention-days: 1
        if-no-files-found: "error"
        compression-level: 0

  macos_aarch64:
    runs-on: macos-15
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python: [
          { version: '3.14t', macosx_target: "15.0", publish: true },
          { version: '3.14', macosx_target: "15.0", publish: true },
        ]
    env:
      CC: "clang"
      LDFLAGS: "-Wl,--as-needed"
      CFLAGS: "-O2 -fstrict-aliasing -fno-plt -mcpu=apple-m1 -mtune=generic"
      #RUSTFLAGS: "-Z unstable-options -C panic=immediate-abort -Z mir-opt-level=4 -Z threads=3 -D warnings"
      PATH: "/Users/runner/work/johnnycanencrypt/johnnycanencrypt/.venv/bin:/Users/runner/.cargo/bin:/usr/local/opt/curl/bin:/usr/local/bin:/usr/local/sbin:/Users/runner/bin:/Library/Frameworks/Python.framework/Versions/Current/bin:/usr/bin:/bin:/usr/sbin:/sbin"
    steps:

    - name: CPU info
      run: sysctl -a | grep brand

    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@main

    - uses: actions/checkout@v5

    - uses: actions/setup-python@v6
      with:
        allow-prereleases: true
        python-version: "${{ matrix.python.version }}"

    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        targets: "aarch64-apple-darwin"
        components: "rust-src"

    - name: Build environment
      run: |
        cargo fetch --target aarch64-apple-darwin &
        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
        brew install nettle pkg-config
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv venv --python python${{ matrix.python.version }}
        uv pip install --upgrade "maturin>=1,<2" -r requirements-dev.txt

    - name: maturin
      run: |
        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
        source .venv/bin/activate
        MACOSX_DEPLOYMENT_TARGET="${{ matrix.python.macosx_target }}" \
        maturin build \
          --release \
          --strip \
          --interpreter python${{ matrix.python.version }} \
          --target=aarch64-apple-darwin

    - name: Runs tests
      run: |
        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
        source .venv/bin/activate
        uv pip install target/wheels/johnnycanencrypt*.whl
        pytest -vvv
      env:
        PYTHONMALLOC: "debug"


    - name: Store wheels
      if: matrix.python.publish == true
      uses: actions/upload-artifact@v4
      with:
        name: johnnycanencrypt_macos_aarch64_${{ matrix.python.version }}
        path: target/wheels
        overwrite: true
        retention-days: 1
        if-no-files-found: "error"
        compression-level: 0


  macos_intel:
    runs-on: macos-15-intel
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python: [
          { version: '3.14', macosx_target: "10.15", publish: true },
        ]
    env:
      CC: "clang"
      CFLAGS: "-O2 -fstrict-aliasing"
      LDFLAGS: "-Wl,--as-needed"
      PATH: "/Users/runner/work/johnnycanencrypt/johnnycanencrypt/.venv/bin:/Users/runner/.cargo/bin:/usr/local/opt/curl/bin:/usr/local/bin:/usr/local/sbin:/Users/runner/bin:/Library/Frameworks/Python.framework/Versions/Current/bin:/usr/bin:/bin:/usr/sbin:/sbin"
    steps:

    - name: CPU info
      run: sysctl -a | grep brand

    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@main

    - uses: actions/checkout@v5

    - uses: actions/setup-python@v6
      with:
        allow-prereleases: true
        python-version: "${{ matrix.python.version }}"

    - uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: x86_64-apple-darwin
        components: "rust-src"

    - name: Build environment
      run: |
        #cargo fetch --target x86_64-apple-darwin &

        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH

        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv venv --python python${{ matrix.python.version }}
        source .venv/bin/activate
        uv pip install --upgrade "maturin>=1,<2" -r requirements-dev.txt

        #mkdir .cargo
        #cp ci/config.toml .cargo/config.toml

    - name: maturin
      run: |
        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
        source .venv/bin/activate
        python3 --version
        python --version
        MACOSX_DEPLOYMENT_TARGET="${{ matrix.python.macosx_target }}" \
        maturin build \
          --release \
          --strip \
          --interpreter python${{ matrix.python.version }}

    - name: Runs tests
      run: |
        export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
        source .venv/bin/activate
        uv pip install target/wheels/johnnycanencrypt*.whl
        pytest -vvv
      env:
        PYTHONMALLOC: "debug"

    - name: Store wheels
      if: matrix.python.publish == true
      uses: actions/upload-artifact@v4
      with:
        name: johnnycanencrypt_universal2_aarch64_${{ matrix.python.version }}
        path: target/wheels
        overwrite: true
        retention-days: 1
        if-no-files-found: "error"
        compression-level: 0

  windows_amd64:
    runs-on: windows-2025
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python: [
          { version: '3.14', publish: true },
        ]
        platform: [
          { arch: "x64", target: "x86_64-pc-windows-msvc",  },
        ]
    env:
      CFLAGS: "-O2"
    steps:

    - name: CPU info
      shell: pwsh
      run: Get-WmiObject -Class Win32_Processor -ComputerName. | Select-Object -Property Name, NumberOfCores, NumberOfLogicalProcessors

    - uses: actions/checkout@v5

    - uses: actions/setup-python@v6
      with:
        allow-prereleases: true
        python-version: "${{ matrix.python.version }}"
        architecture: "${{ matrix.platform.arch }}"

    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        targets: "${{ matrix.platform.target }}"
        components: "rust-src"

    - name: Build environment
      run: |
        cargo fetch --target "${{ matrix.platform.target }}" &
        python.exe -m pip install --upgrade pip "maturin>=1,<2" wheel
        python.exe -m pip install -r requirements-dev.txt
        mkdir .cargo
        cp ci\config.toml .cargo\config.toml
    - name: maturin
      run: |
        maturin.exe build --release --strip --target="${{ matrix.platform.target }}"
        python.exe -m pip install johnnycanencrypt --no-index --find-links target\wheels

    - name: Run tests in a virtual environment
      shell: pwsh
      run: |
        python -m venv venv
        .\venv\Scripts\Activate.ps1
        pip install -r requirements-dev.txt
        pip install johnnycanencrypt --no-index --find-links target\wheels
        cd tests
        python -m pytest -vvv

    - name: Store wheels
      if: matrix.python.publish == true
      uses: actions/upload-artifact@v4
      with:
        name: johnnycanencrypt_windows_amd64_${{ matrix.platform.arch }}_${{ matrix.python.version }}
        path: target\wheels
        overwrite: true
        retention-days: 1
        if-no-files-found: "error"
        compression-level: 0

  windows_aarch64:
    runs-on: windows-11-arm
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python: [
          { version: '3.14', publish: true },
        ]
    env:
      CFLAGS: "-O2"
      TARGET: "aarch64-pc-windows-msvc"
    steps:

    - name: CPU info
      shell: pwsh
      run: Get-WmiObject -Class Win32_Processor -ComputerName. | Select-Object -Property Name, NumberOfCores, NumberOfLogicalProcessors

    - uses: actions/checkout@v5

    - uses: actions/setup-python@v6
      with:
        allow-prereleases: true
        python-version: "${{ matrix.python.version }}"
        architecture: "arm64"

    # from maturin
    - shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://static.rust-lang.org/rustup/dist/$env:TARGET/rustup-init.exe" -OutFile rustup-init.exe
        .\rustup-init.exe --default-toolchain "stable-$env:TARGET" --profile minimal --component rust-src -y
        "$env:USERPROFILE\.cargo\bin" | Out-File -Append -Encoding ascii $env:GITHUB_PATH
        "CARGO_HOME=$env:USERPROFILE\.cargo" | Out-File -Append -Encoding ascii $env:GITHUB_ENV
    - name: Build environment
      run: |
        cargo fetch --target "$" &
        python.exe -m sysconfig
        python.exe -m pip install --upgrade pip "maturin>=1,<2" wheel
        python.exe -m pip install -r requirements-dev.txt

    - name: maturin
      run: |
        maturin.exe build --release --strip --target="$env:TARGET"

    - name: Run tests in a virtual environment
      shell: pwsh
      run: |
        python -m venv venv
        .\venv\Scripts\Activate.ps1
        pip install -r requirements-dev.txt
        pip install johnnycanencrypt --no-index --find-links target\wheels
        cd tests
        python -m pytest -vvv

    - name: Store wheels
      if: matrix.python.publish == true
      uses: actions/upload-artifact@v4
      with:
        name: johnnycanencrypt_windows_aarch64_${{ matrix.python.version }}
        path: target\wheels
        overwrite: true
        retention-days: 1
        if-no-files-found: "error"
        compression-level: 0
 
# Task to download and upload artifacts from all builds
  collect_wheels:
    runs-on: ubuntu-latest
    needs: [manylinux_x86_64, macos_aarch64, macos_intel, windows_amd64, windows_aarch64]
    steps:
    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        path: wheels
        pattern: johnnycanencrypt_*
        merge-multiple: true

    - name: Upload all wheels
      uses: actions/upload-artifact@v4
      with:
        name: all_wheels
        path: wheels
        retention-days: 2
        if-no-files-found: "error"
        compression-level: 0

